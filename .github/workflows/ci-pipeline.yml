name: CI/CD Pipeline - All Stages

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # ========== STAGE 1: SOURCE ==========
  source-stage:
    runs-on: ubuntu-latest
    name: "Stage 1: Source & Trigger"
    outputs:
      commit_sha: ${{ github.sha }}
      branch_name: ${{ github.ref_name }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Source Stage Info
      run: |
        echo "=== SOURCE STAGE ==="
        echo "Event: ${{ github.event_name }}"
        echo "Repository: ${{ github.repository }}"
        echo "SHA: ${{ github.sha }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Actor: ${{ github.actor }}"
        
    - name: Generate Source Report
      run: |
        echo "# Source Stage Report" > source-report.md
        echo "## Status: COMPLETED" >> source-report.md
        echo "## Timestamp: $(date)" >> source-report.md
        echo "## Repository: ${{ github.repository }}" >> source-report.md
        echo "## Commit: ${{ github.sha }}" >> source-report.md
        echo "## Trigger: ${{ github.event_name }}" >> source-report.md
        echo "## Next: Build Stage" >> source-report.md
        
    - name: Upload Source Report
      uses: actions/upload-artifact@v3
      with:
        name: source-documents
        path: source-report.md

  # ========== STAGE 2: BUILD ==========
  build-stage:
    runs-on: ubuntu-latest
    name: "Stage 2: Build & Docker Images"
    needs: source-stage
    if: success()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup build environment
      run: |
        echo "=== BUILD ENVIRONMENT ==="
        echo "Python version:"
        python --version
        echo "Docker version:"
        docker --version
        echo "Docker Compose version:"
        docker-compose --version
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install Poetry
      run: |
        pip install poetry
        poetry --version
        
    - name: Install backend dependencies
      working-directory: ./backend
      run: |
        poetry install --no-interaction --no-ansi
        
    - name: Build Docker images with Docker Compose
      run: |
        echo "Building Docker images..."
        docker-compose build --no-cache
        
        echo "Images built:"
        docker images | grep crud-rental-properties
        
    - name: Tag Docker images
      run: |
        echo "Tagging Docker images..."
        docker tag crud-rental-properties-backend:latest crud-backend:${{ github.sha }}
        docker tag crud-rental-properties-frontend:latest crud-frontend:${{ github.sha }}
        
        echo "Current Docker images:"
        docker images | grep -E "(crud-backend|crud-frontend)"
        
    - name: Save Docker images as artifacts
      run: |
        echo "Saving Docker images to tar files..."
        docker save -o backend-image-${{ github.sha }}.tar crud-backend:${{ github.sha }}
        docker save -o frontend-image-${{ github.sha }}.tar crud-frontend:${{ github.sha }}
        
        echo "Created artifact files:"
        ls -la *.tar
        
    - name: Create Build Report
      run: |
        echo "# Build Stage Report" > build-report.md
        echo "## Status: SUCCESS" >> build-report.md
        echo "## Timestamp: $(date)" >> build-report.md
        echo "## Build ID: ${{ github.run_id }}" >> build-report.md
        echo "## Commit: ${{ github.sha }}" >> build-report.md
        echo "## Images Built:" >> build-report.md
        echo "" >> build-report.md
        echo "### Backend (FastAPI)" >> build-report.md
        echo "- Tag: crud-backend:${{ github.sha }}" >> build-report.md
        echo "- Tag: crud-backend:latest" >> build-report.md
        echo "- Size: $(docker images --format "{{.Size}}" crud-backend:${{ github.sha }})" >> build-report.md
        echo "" >> build-report.md
        echo "### Frontend (Streamlit)" >> build-report.md
        echo "- Tag: crud-frontend:${{ github.sha }}" >> build-report.md
        echo "- Tag: crud-frontend:latest" >> build-report.md
        echo "- Size: $(docker images --format "{{.Size}}" crud-frontend:${{ github.sha }})" >> build-report.md
        echo "" >> build-report.md
        echo "## Artifacts Created:" >> build-report.md
        echo "- backend-image-${{ github.sha }}.tar" >> build-report.md
        echo "- frontend-image-${{ github.sha }}.tar" >> build-report.md
        echo "" >> build-report.md
        echo "## Dependencies:" >> build-report.md
        echo "- Python 3.11" >> build-report.md
        echo "- Poetry for dependency management" >> build-report.md
        echo "- PostgreSQL (database)" >> build-report.md
        echo "" >> build-report.md
        echo "## Next Stage: Testing" >> build-report.md
        
        cat build-report.md
        
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: build-artifacts
        path: |
          *.tar
          build-report.md
        retention-days: 7
        
    - name: Upload Docker Images to GitHub Container Registry (Optional)
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        echo "This step would push to GitHub Container Registry"
        echo "Images ready for:"
        echo "- crud-backend:${{ github.sha }}"
        echo "- crud-frontend:${{ github.sha }}"
        echo "To enable, add GitHub token with packages:write permission"
        
    - name: Build Stage Complete
      run: |
        echo "âœ… BUILD STAGE COMPLETED SUCCESSFULLY!"
        echo "ğŸ“¦ Docker images created:"
        docker images | grep crud
        echo "ğŸ“ Artifacts saved for testing stage"
        echo "ğŸ”œ Next: Test Stage"

  # ========== STAGE 3: TEST (Coming Next) ==========
  test-stage:
    runs-on: ubuntu-latest
    name: "Stage 3: Testing"
    needs: build-stage
    if: success()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Test Stage Placeholder
      run: |
        echo "=== TEST STAGE ==="
        echo "Test stage will be implemented next"
        echo "Will include:"
        echo "- Unit tests (Pytest)"
        echo "- Integration tests"
        echo "- API endpoint testing"
        echo "This stage depends on successful build"